
## **1. Mục tiêu**

Bài này hướng dẫn bạn:

* Tạo một **action** mới trong ROS 2.
* Hiểu **cấu trúc file `.action`** (gồm request, result, feedback).
* Biết cách **cấu hình CMakeLists.txt và package.xml** để ROS 2 sinh code tự động.
* Kiểm tra xem action có được build thành công hay chưa.

---

## **2. Kiến thức nền**

* Trong ROS 2, **action** là một loại giao tiếp *asynchronous* (không đồng bộ) giữa **action client** và **action server**.
* Khác với:

  * **topic** → truyền dữ liệu liên tục, 1 chiều.
  * **service** → yêu cầu – phản hồi *một lần duy nhất*.
  * **action** → hỗ trợ gửi yêu cầu (goal), nhận phản hồi cuối (result), và nhận feedback trong khi đang xử lý.
* Mỗi **action** có **3 phần tách biệt bởi `---`**:

  1. **Request**: dữ liệu client gửi để bắt đầu goal.
  2. **Result**: dữ liệu server gửi khi goal hoàn tất.
  3. **Feedback**: dữ liệu server gửi liên tục để báo tiến độ.

---

## **3. Các bước thực hiện**

### **Bước 1 — Tạo package chứa interface**

Bạn cần một package chuyên để lưu trữ định nghĩa interface (msg, srv, action).
Ví dụ:

```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src
ros2 pkg create --license Apache-2.0 custom_action_interfaces
```

> Package này **chỉ chứa định nghĩa interface**, không chứa node chạy.

---

### **Bước 2 — Tạo file `.action`**

1. Vào thư mục package:

```bash
cd custom_action_interfaces
mkdir action
```

2. Tạo file **`Fibonacci.action`**:

```bash
int32 order
---
int32[] sequence
---
int32[] partial_sequence
```

📌 Ý nghĩa:

* **Request** (`order`) → client yêu cầu server tính dãy Fibonacci đến phần tử thứ *order*.
* **Result** (`sequence`) → toàn bộ dãy Fibonacci khi hoàn thành.
* **Feedback** (`partial_sequence`) → các phần tử đã tính được ở thời điểm hiện tại.

---

### **Bước 3 — Cấu hình build**

Mở **`CMakeLists.txt`** và **thêm trước** `ament_package()`:

```cmake
find_package(rosidl_default_generators REQUIRED)

rosidl_generate_interfaces(${PROJECT_NAME}
  "action/Fibonacci.action"
)
```

Mở **`package.xml`** và thêm:

```xml
<buildtool_depend>rosidl_default_generators</buildtool_depend>
<member_of_group>rosidl_interface_packages</member_of_group>
```

> `rosidl_generate_interfaces` sẽ gọi trình sinh mã (code generation pipeline) để tạo ra file header `.hpp` (C++) hoặc `.py` (Python) từ định nghĩa `.action`.

---

### **Bước 4 — Build package**

```bash
cd ~/ros2_ws
colcon build
```

* Sau khi build, action sẽ có tên đầy đủ:

  ```
  custom_action_interfaces/action/Fibonacci
  ```
* Tên này gồm: **tên package** + `/action/` + **tên action**.

---

### **Bước 5 — Kiểm tra action**

1. Source workspace:

```bash
source install/local_setup.bash
```

2. Kiểm tra:

```bash
ros2 interface show custom_action_interfaces/action/Fibonacci
```

Kết quả sẽ in ra:

```text
int32 order
---
int32[] sequence
---
int32[] partial_sequence
```

---

## **4. Tóm tắt quy trình**

1. **Tạo package interface** (chứa file `.action`).
2. **Định nghĩa action** với 3 phần: request, result, feedback.
3. **Khai báo trong CMakeLists.txt và package.xml**.
4. **Build bằng colcon** để sinh code.
5. **Kiểm tra bằng `ros2 interface show`**.

---

## **5. Hình minh họa luồng dữ liệu của action**

```
[Client] --(Goal Request)--> [Server]
[Client] <--(Feedback)------ [Server]
[Client] <--(Result)-------- [Server]
```

* Client gửi request → Server xử lý.
* Server vừa gửi feedback liên tục → Khi xong, gửi result.

---
