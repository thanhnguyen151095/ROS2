## **1. Khái niệm cơ bản**

* **Action** trong ROS 2 là kiểu giao tiếp **bất đồng bộ** giữa **action client** và **action server**.
* Quy trình:

  1. **Client** gửi một *goal request* → yêu cầu server làm gì đó.
  2. **Server** chấp nhận (hoặc từ chối) yêu cầu.
  3. Trong khi chạy, **server** có thể gửi **feedback** để báo tiến độ.
  4. Khi hoàn thành, **server** gửi **result**.

> Bài này sẽ dùng **action Fibonacci** đã tạo ở bài trước (*order → sequence + feedback partial\_sequence*).

---

## **2. Phần 1 — Viết Action Server**

### **Bước 1: Tạo file Python**

* Tạo file `fibonacci_action_server.py`.
* Viết class `FibonacciActionServer` kế thừa từ `Node`.

### **Bước 2: Tạo Action Server**

Trong constructor:

```python
self._action_server = ActionServer(
    self,            # Node hiện tại
    Fibonacci,       # Loại action (đã import từ custom_action_interfaces)
    'fibonacci',     # Tên action
    self.execute_callback # Hàm xử lý khi có goal mới
)
```

### **Bước 3: Viết `execute_callback`**

* Hàm này chạy khi có **goal mới được chấp nhận**.
* Ban đầu chỉ in `"Executing goal..."`.
* Nếu không set trạng thái goal, mặc định là **aborted**.
* Để báo thành công:

```python
goal_handle.succeed()
```

### **Bước 4: Thêm xử lý tính dãy Fibonacci**

* Tạo list chứa số Fibonacci.
* Gán vào `result.sequence`.
* Trả về `result`.

### **Bước 5: Gửi Feedback**

* Tạo biến `feedback_msg` chứa **partial\_sequence**.
* Mỗi lần tính thêm số mới:

  * Cập nhật `feedback_msg.partial_sequence`.
  * Gọi `goal_handle.publish_feedback(feedback_msg)`.
  * `time.sleep(1)` để thấy rõ quá trình.

**Chạy thử:**

```bash
# Terminal 1
python3 fibonacci_action_server.py

# Terminal 2
ros2 action send_goal --feedback fibonacci custom_action_interfaces/action/Fibonacci "{order: 5}"
```

---

## **3. Phần 2 — Viết Action Client**

### **Bước 1: Tạo file Python**

* Tạo file `fibonacci_action_client.py`.
* Viết class `FibonacciActionClient` kế thừa `Node`.

### **Bước 2: Tạo Action Client**

```python
self._action_client = ActionClient(
    self,
    Fibonacci,   # Loại action
    'fibonacci'  # Tên action
)
```

### **Bước 3: Gửi Goal**

* Hàm `send_goal`:

  * `wait_for_server()` → đợi server sẵn sàng.
  * `send_goal_async(goal_msg)` → gửi goal.
  * Trả về **future** để xử lý sau.

### **Bước 4: Nhận Result**

* Khi future trả về **goal handle**:

  * Nếu bị từ chối → return.
  * Nếu chấp nhận → gọi `get_result_async()` để lấy kết quả.
* In kết quả rồi shutdown node.

### **Bước 5: Nhận Feedback**

* Viết `feedback_callback(feedback_msg)`:

  * In `feedback_msg.feedback.partial_sequence`.
* Khi gửi goal, truyền thêm callback:

```python
send_goal_async(goal_msg, feedback_callback=self.feedback_callback)
```

**Chạy thử:**

```bash
# Terminal 1
python3 fibonacci_action_server.py

# Terminal 2
python3 fibonacci_action_client.py
```

---

## **4. Tóm tắt luồng hoạt động**

```
Client:  send_goal() --------------> Server
         <---- goal_accepted -------
         <---- feedback ------------
         <---- feedback ------------
         <---- result --------------
```

* **send\_goal()**: gửi yêu cầu với dữ liệu `order`.
* **Server** tính toán, vừa gửi feedback vừa xử lý.
* **Khi xong**, gửi kết quả cuối (`sequence`).

---

## **5. Điểm cần nhớ**

* **Server**: `ActionServer(node, type, name, callback)`
* **Client**: `ActionClient(node, type, name)`
* **Goal Handle**:

  * `goal_handle.succeed()` → báo thành công.
  * `goal_handle.publish_feedback(feedback_msg)` → gửi feedback.
* **Client** dùng callback để nhận **feedback** và **result** tách biệt.

---
