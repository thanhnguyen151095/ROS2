
`turtlesim` là một simulator nhỏ, 2D, dùng để học các khái niệm cơ bản của ROS 2: **node**, **topic**, **service**, **parameter**, **message types**, **publisher/subscriber**, và các công cụ CLI (`ros2 topic`, `ros2 service`, `ros2 param`, ...). Bạn có thể chạy một con rùa (turtle) trên màn hình, điều khiển nó bằng phím hoặc bằng cách publish `Twist`, spawn/kill turtle bằng service, v.v.

---

# 1) Chuẩn bị & khởi động

1. Source môi trường ROS 2:

```bash
source /opt/ros/jazzy/setup.bash
```

2. Cài (nếu chưa có):

```bash
sudo apt update
sudo apt install ros-jazzy-turtlesim
```

3. Chạy node chính (mở terminal):

```bash
ros2 run turtlesim turtlesim_node
```

Bạn sẽ thấy cửa sổ đồ họa có một con rùa.

4. Điều khiển bằng bàn phím (mở terminal khác):

```bash
ros2 run turtlesim turtle_teleop_key
```

Dùng phím mũi tên / wasd để di chuyển.

---

# 2) Topic chính & message types

* **Điều khiển vận tốc:** topic `/turtle1/cmd_vel` — type `geometry_msgs/msg/Twist`.

  * `linear.x` = tốc độ tiến, `angular.z` = tốc quay.
* **Trạng thái vị trí:** topic `/turtle1/pose` — type `turtlesim/msg/Pose` (các trường `x, y, theta, linear_velocity, angular_velocity`).

Một số lệnh CLI để khám phá:

```bash
ros2 topic list
ros2 topic type /turtle1/pose              # in ra turtlesim/msg/Pose
ros2 interface show turtlesim/msg/Pose    # xem trường của message
ros2 topic echo /turtle1/pose             # xem giá trị pose realtime
ros2 topic info /turtle1/cmd_vel          # xem publisher/subscriber hiện tại
```

Publish lệnh vận tốc (liên tục, rate 10Hz):

```bash
ros2 topic pub -r 10 /turtle1/cmd_vel geometry_msgs/msg/Twist "{linear: {x: 1.0}, angular: {z: 0.5}}"
```

Publish một lần:

```bash
ros2 topic pub --once /turtle1/cmd_vel geometry_msgs/msg/Twist "{linear: {x: 2.0}, angular: {z: 0.0}}"
```

---

# 3) Services (spawn / kill / clear / teleport)

Một số service quan trọng:

* `/spawn` — `turtlesim/srv/Spawn` : tạo một turtle mới.
* `/kill` — `turtlesim/srv/Kill` : xoá turtle theo tên.
* `/clear` — `std_srvs/srv/Empty` : xóa đường vẽ, làm sạch màn hình.
* `/turtle1/teleport_absolute` — `turtlesim/srv/TeleportAbsolute` : đặt vị trí tức thì.

Ví dụ gọi service:

```bash
# spawn turtle2 tại (x=4,y=2)
ros2 service call /spawn turtlesim/srv/Spawn "{x: 4.0, y: 2.0, theta: 0.0, name: 'turtle2'}"

# kill turtle2
ros2 service call /kill turtlesim/srv/Kill "{name: 'turtle2'}"

# clear background
ros2 service call /clear std_srvs/srv/Empty "{}"

# teleport turtle1 tới toạ độ (5,5)
ros2 service call /turtle1/teleport_absolute turtlesim/srv/TeleportAbsolute "{x: 5.0, y: 5.0, theta: 1.57}"
```

**Ghi chú:** khi spawn thêm turtle, bạn sẽ có topic `/turtle2/cmd_vel` và `/turtle2/pose` tương ứng.

---

# 4) Parameters (thay đổi màu nền)

Node `turtlesim` có parameter `background_r`, `background_g`, `background_b` (0–255). Ví dụ:

```bash
ros2 param list /turtlesim
ros2 param get /turtlesim background_r
ros2 param set /turtlesim background_r 200
ros2 param set /turtlesim background_g 50
```

Thay đổi này sẽ lập tức cập nhật màu nền cửa sổ turtlesim.

---

# 5) Khám phá message & interface

* Xem định nghĩa message:

```bash
ros2 interface show geometry_msgs/msg/Twist
ros2 interface show turtlesim/msg/Pose
```

* Xem danh sách service:

```bash
ros2 service list
ros2 service type /spawn
```

---

# 6) Ví dụ code — Publisher/Subcriber Python (rclpy)

Một node Python đơn giản publish `Twist` và subscribe `Pose`:

```python
# move_turtle.py
import rclpy
from rclpy.node import Node
from geometry_msgs.msg import Twist
from turtlesim.msg import Pose

class TurtleMover(Node):
    def __init__(self):
        super().__init__('turtle_mover')
        self.pub = self.create_publisher(Twist, '/turtle1/cmd_vel', 10)
        self.sub = self.create_subscription(Pose, '/turtle1/pose', self.pose_cb, 10)
        self.timer = self.create_timer(0.5, self.timer_cb)

    def timer_cb(self):
        msg = Twist()
        msg.linear.x = 1.0     # tiến
        msg.angular.z = 0.5    # quay
        self.pub.publish(msg)

    def pose_cb(self, msg):
        self.get_logger().info(f'pose: x={msg.x:.2f}, y={msg.y:.2f}, theta={msg.theta:.2f}')

def main(args=None):
    rclpy.init(args=args)
    node = TurtleMover()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()
```

Chạy:

```bash
# source env trước, sau đó
python3 move_turtle.py
```

---

# 7) Dùng công cụ đồ hoạ/giám sát

* `rqt_graph` hiển thị đồ thị nodes ↔ topics:

```bash
ros2 run rqt_graph rqt_graph
```

* `ros2 run rqt_console rqt_console` và `rqt_plot` (nếu muốn đồ thị hóa biến).

---

# 8) Bài tập gợi ý (thực hành)

1. Spawn thêm `turtle2` và điều khiển nó bằng `ros2 topic pub` (nhìn 2 con rùa di chuyển).
2. Viết node theo dõi `/turtle1/pose` và tự động gửi `cmd_vel` để đưa turtle về toạ độ (x\_goal, y\_goal) — tập làm control cơ bản.
3. Thay đổi màu nền bằng `ros2 param set` rồi spawn/kill để quan sát.
4. Dùng `rqt_graph` để quan sát mối liên hệ publisher/subscriber khi chạy teleop và node do bạn viết.

---

# Mẹo & lưu ý nhỏ

* Luôn `source /opt/ros/jazzy/setup.bash` trước khi chạy lệnh `ros2`. Nếu làm việc trong workspace, `source install/setup.bash` của workspace để dùng gói bạn build.
* Khi dùng `ros2 service call`/`ros2 topic pub`, chú ý **cú pháp quoting** trên shell (dùng `{...}` kiểu YAML/JSON). Nếu gặp lỗi parsing, thử đổi kiểu dấu ngoặc/nháy.
* Dùng `ros2 interface show` + `ros2 topic type` để chắc chắn bạn publish đúng kiểu message.

---
